name: 'YOLO Detection Alert with Video'

on:
  workflow_dispatch:  # 添加这一行，允许通过API手动触发
    inputs:
      object:
        description: 'Person'
        required: true
        type: string
      confidence:
        description: '>=0.5'
        required: true
        type: string
      time:
        description: 'Time'
        required: true
        type: string
      email_header:
        description: 'Email header'
        required: true
        type: string
      recipient:
        description: 'Email address'
        required: true
        type: string
      download_url:  # 添加视频下载URL输入
        description: 'Video download URL'
        required: false
        type: string
        default: 'No video available'

jobs:
  alert:
    name: Send Email Alert
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Send Email via SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sina.com
          server_port: 465
          secure: true
          username: ${{ secrets.SINA_MAIL }}
          password: ${{ secrets.SINA_AUTH_CODE }}
          subject: '🚨 安全警报: ${{ inputs.object }}检测通知 - ${{ inputs.email_header }}'
          body: |
            ${{ inputs.email_header }},

            The drone has identified some specious objects in your house:

            - **Object:** ${{ inputs.object }}
            - **Confidence Level:** ${{ inputs.confidence }}
            - **Time:** ${{ inputs.time }}

            ${{ inputs.download_url != 'No video available' && '**Please check the video footage:**' || '' }}
            ${{ inputs.download_url != 'No video available' && inputs.download_url || '' }}
            ${{ inputs.download_url != 'No video available' && 'Note: the download URL is from Github, which is safe and will expire in 24 hours' || '' }}

            此为自动发送的安全通知，请勿直接回复。
            如有任何疑问，请及时联系安全团队。

            祝好,
            无人机安全监控系统
          to: ${{ inputs.recipient }}
          from: 无人机安全监控系统 <${{ secrets.SINA_MAIL }}>
